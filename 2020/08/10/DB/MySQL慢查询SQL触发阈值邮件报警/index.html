<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    
    <title>
        MySQL慢查询SQL触发阈值邮件报警 | 国家一级保护废物
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <link rel="shortcut icon" href="/images/favicon.png">
    
    
<link rel="stylesheet" href="/css/style.css">

    <script id="hexo-configurations">
    let CONFIG = {"hostname":"schnappi618.github.io","root":"/","localsearch":{"enable":true,"trigger":"auto","unescape":false,"preload":false},"themeInfo":{"name":"ILS","version":"1.1.2","author":"XPoet","repository":"https://github.com/XPoet/hexo-theme-ils"},"path":"search.json"};
  </script>
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="国家一级保护废物" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>


<body>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="page-template">
    <div class="page-top">
        <header class="header-wrapper">

    <div class="header-progress"></div>

    <div class="header-content">

        <a class="logo-title" href="/">
            国家一级保护废物
        </a>

        <ul class="menu-list">
            
                <li class="menu-item">
                    <a class=""
                       href="/"
                    >
                        首页
                    </a>
                </li>
            
                <li class="menu-item">
                    <a class=""
                       href="/archives"
                    >
                        归档
                    </a>
                </li>
            
                <li class="menu-item">
                    <a class=""
                       href="/links"
                    >
                        友链
                    </a>
                </li>
            
                <li class="menu-item">
                    <a class=""
                       href="/about"
                    >
                        关于
                    </a>
                </li>
            
        </ul>

        <div class="menu-bar">
            <div class="menu-bar-middle"></div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item">
                    <a class=""
                       href="/links">友链</a>
                </li>
            
                <li class="drawer-menu-item">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


    </div>

    <div class="page-middle ">

        <main class="main-content normal-code-theme">

            <div class="main-content-left">
                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <h3><a class="title-hover-animation">MySQL慢查询SQL触发阈值邮件报警</a></h3>
        </div>

        <div class="meta-info">
            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa fa-calendar-o"></i> 2020-08-10 10:55:18
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fa fa-folder"></i>
            <ul>
                
                    <li>
                        <a href="/categories/MySQL/">MySQL</a>
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa fa-tags"></i>
            <ul>
                
                    <li>
                        <a href="/tags/MySQL/">MySQL</a>
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>
        </div>

        <div class="article-content markdown-body">
            <p>这个只是我作为数据库和开发小白自己的一个解决思路，如果有更恰当的思路，欢迎评论或私聊呀～</p>
<h2 id="一、项目背景"><a href="#一、项目背景" class="headerlink" title="一、项目背景"></a>一、项目背景</h2><p>业务数据库被异常调用时导致慢查询量增大，影响到正常业务使用，业务只能通过nginx超时异常等来进行问题排查，增大了定位和处理问题的难度、时间，尤其商品库或者交易库可能会出现页面无法正常显示的情况。故业务需求为若主库和从库慢查询总量每分钟超过某个阈值之后则发送邮件报警。</p>
<h2 id="二、开发逻辑问题及处理"><a href="#二、开发逻辑问题及处理" class="headerlink" title="二、开发逻辑问题及处理"></a>二、开发逻辑问题及处理</h2><h3 id="1、问题梳理"><a href="#1、问题梳理" class="headerlink" title="1、问题梳理"></a>1、问题梳理</h3><ol>
<li>由于主库和从库在不同主机上，故不能开启pt-kill的<code>--log-dsn</code>参数将pt-kill结果写入数据库中，否则会出现主从数据不一致，从而导致主从异常中断</li>
<li>pt-kill在哪台主机上执行，如果pt-kill在主库、从库本身机器上执行，会将文件写入到本地，pt-kill效率的确最高，但后续如何将文件汇总到一起；而且最终需要将日志文件作为附件发送邮件，线上机器无法到外网，所以还需要分别将文件传输到中控机等可以访问外网的机器上</li>
<li>对应数据库的主库、从库可能会由于实例均衡发生变动，若直接在对应主机上启动pt-kill，会出现异常情况，并且还需要代码变动</li>
<li>pt-kill日志文件时间问题，本次需求为超过1分钟的数量触发到阈值之后发送邮件报警，若所有pt-kill结果都放入一个文件，这个文件会越来越大，不仅处理时间会越来越长，而且获取1分钟内的记录计算数量可能会存在漏掉或重复计算的情况</li>
<li>邮件内容如何发送，虽使用附件将pt-kill日志发送，但仍需要将统计内容作为邮件正文</li>
</ol>
<h3 id="2、问题处理"><a href="#2、问题处理" class="headerlink" title="2、问题处理"></a>2、问题处理</h3><ol>
<li>直接在中控机上执行对应的pt-kill命令</li>
<li>使用pt-kill的<code>--log</code>参数直接将kill掉的记录写入到本地文件中</li>
<li>使用多进程每一分钟启动对应的pt-kill进程，并写入到对应文件中，日志文件命名为<code>角色_端口_主机区分_时间戳_slow.log</code>。例如：主库某个时间的文件名为：<code>m_3306_733_20200810114116_slow.log</code>，表示端口为3306的主库，在主机后两位为733上2020年8月10日11时41分16秒生成的kill日志文件</li>
<li>pt-kill进程结束后使用子进程grep对应文件来获取慢SQL数量，并记录下来</li>
<li>由于为1min便有新的日志文件生成，时间久了之后数据量会特别大，还需要一个定时任务去清除日志文件。这里直接使用了crontab清除每10分钟清除30min之前的日志文件</li>
<li>邮件正文通过html写为表格，详细慢查询SQL直接通过附件发送</li>
</ol>
<h2 id="三、逻辑流程梳理"><a href="#三、逻辑流程梳理" class="headerlink" title="三、逻辑流程梳理"></a>三、逻辑流程梳理</h2><ol>
<li>持续使用percona提供的pt-kill工具kill对应数据库集群(主库+从库)的超过2s的慢查询并记录到日志文件中<ol>
<li>在管理库上获取对应集群的主库和从库主机名等信息</li>
<li>使用合适的pt-kill参数将每分钟kill掉的慢SQL记录到文件中</li>
</ol>
</li>
<li>获取主库和从库总共kill的慢SQL数量<ol>
<li>获取每个主库和从库日志文件所记录的kill慢SQL数量</li>
<li>获取所有主机被kill的慢SQL总数</li>
</ol>
</li>
<li>如果超过设定的阈值，则发送邮件报警<ol>
<li>判断是否超过设置阈值</li>
<li>超过则发送邮件报警</li>
</ol>
</li>
</ol>
<h2 id="四、主要功能代码"><a href="#四、主要功能代码" class="headerlink" title="四、主要功能代码"></a>四、主要功能代码</h2><p><strong>由于markdown粘贴代码，缩进可能有部分问题，复制粘贴后需注意一下，并且这里取消了log模块，可将需要内容打印到使用的log中去</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 公共函数</span></span><br><span class="line"><span class="comment">## 1. 获取数据库连接</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">adminMySQLConn</span><span class="params">(User,Pass,Host,Port,DBName)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            adminConn=<span class="string">"mysql+pymysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;?charset=utf8mb4"</span>.\</span><br><span class="line">                    format(User,Pass,Host,Port,DBName)</span><br><span class="line">            adminEngine = create_engine(adminConn)</span><br><span class="line">            <span class="keyword">return</span> adminEngine</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">            self.log.error(<span class="string">"adminMySQLConn: &#123;&#125;"</span>.format(err))</span><br><span class="line">            <span class="comment">#self.log.error("adminMySQLConn: &#123;&#125;".format(err.message))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 2. 获取当前时间戳</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initCurrentDateTime</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> datetime.now().strftime(<span class="string">'%Y%m%d%H%M%S'</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">            self.log.error(<span class="string">"initCurrentDateTime: &#123;&#125;"</span>.format(err.message))</span><br><span class="line"></span><br><span class="line"><span class="comment">## 3. 远程/本地执行linux命令(在本地执行可以直接使用os.system或subprocess.getstatusoutput，但由于这里是个公共函数，其他程序可能需要远程执行，故这里统一使用paramiko执行)</span></span><br><span class="line"><span class="keyword">from</span> paramiko <span class="keyword">import</span> SSHClient, AutoAddPolicy</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">executeSSH</span><span class="params">(ip, cmds)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">            client = SSHClient()</span><br><span class="line">            client.set_missing_host_key_policy(AutoAddPolicy())</span><br><span class="line">            system(<span class="string">'kinit -kt /etc/krb5.keytab'</span>)</span><br><span class="line">            client.connect(ip, look_for_keys=<span class="literal">False</span>, gss_auth=<span class="literal">True</span>, gss_kex=<span class="literal">True</span>)</span><br><span class="line">            stdin, stdout, stderr = client.exec_command(cmds)</span><br><span class="line">            <span class="comment"># result = stdout.readlines()       # 获取命令执行结果,返回的数据是一个list</span></span><br><span class="line">            _result = stdout.read().decode()  <span class="comment"># 命令执行结果</span></span><br><span class="line">            _status = stdout.channel.recv_exit_status()  <span class="comment"># 命令执行状态码</span></span><br><span class="line">            client.close()</span><br><span class="line">            <span class="keyword">return</span> _status, _result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># print(e)</span></span><br><span class="line">            <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>

<h3 id="1、获取初始化信息"><a href="#1、获取初始化信息" class="headerlink" title="1、获取初始化信息"></a>1、获取初始化信息</h3><p>由于这里存在一个管理库，上面有所有数据库的信息，则通过pymysql去查看并获取对应信息即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入信息，即GetHost中的info</span></span><br><span class="line">Inputinfo = &#123;<span class="string">"rsPort"</span>: <span class="number">3306</span><span class="string">'&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tb_mysql_instance为管理表，其中：rsPort为端口，rsHost为对应数据库所在主机，rsRole为数据库角色：master主库，slave从库</span></span><br><span class="line">SQLlist = &#123;</span><br><span class="line">    <span class="string">"getHost"</span>: <span class="string">"select rsHost, rsPort, rsRole from tb_mysql_instance where rsPort = &#123;&#125; and rsRole in ('master', 'slave');"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetHost</span><span class="params">(**info)</span>:</span></span><br><span class="line">    port = info[<span class="string">'rsPort'</span>]</span><br><span class="line">    insInfoList = []</span><br><span class="line">    adminConn = adminMySQLConn()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        executeSQL = SQLlist[<span class="string">'getHost'</span>].format(port)</span><br><span class="line">        insList = adminConn.execute(executeSQL).fetchall()</span><br><span class="line">        <span class="keyword">if</span> insList:</span><br><span class="line">            datetime = initCurrentDateTime()</span><br><span class="line">            <span class="keyword">for</span> insInfo <span class="keyword">in</span> insList:</span><br><span class="line">                infoDict = dict(zip(insInfo.keys(), insInfo.values()))</span><br><span class="line">                <span class="keyword">if</span> infoDict[<span class="string">'rsRole'</span>] == <span class="string">'master'</span>:</span><br><span class="line">                    infoDict[<span class="string">'logFile'</span>] = <span class="string">"m_&#123;&#125;_&#123;&#125;_&#123;&#125;_slow.log"</span>.format(infoDict[<span class="string">'rsPort'</span>],<span class="string">''</span>.join(infoDict[<span class="string">'rsHost'</span>].split(<span class="string">'.'</span>)[<span class="number">2</span>:]) , datetime)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    infoDict[<span class="string">'logFile'</span>] = <span class="string">"s_&#123;&#125;_&#123;&#125;_&#123;&#125;_slow.log"</span>.format(infoDict[<span class="string">'rsPort'</span>],<span class="string">''</span>.join(infoDict[<span class="string">'rsHost'</span>].split(<span class="string">'.'</span>)[<span class="number">2</span>:]) , datetime)</span><br><span class="line">                infoDict[<span class="string">'ptkillLogFile'</span>] = <span class="string">"./SlowLog/&#123;&#125;"</span>.format(infoDict[<span class="string">'logFile'</span>])</span><br><span class="line">                insInfoList.append(infoDict)</span><br><span class="line">            msg = <span class="string">"Get &#123;&#125; pt-kill master and slave host info success."</span>.format(port)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span>, insInfoList</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">"Get &#123;&#125; pt-kill master and slave host info failed. SQL:&#123;&#125; insList: "</span>.format(port, executeSQL), insList</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">        msg = <span class="string">"Get &#123;&#125; pt-kill master and slave host info err: "</span>.format(port), err</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输出结果示例：</span></span><br><span class="line">[&#123;<span class="string">'rsHost'</span>: <span class="string">'1.1.1.1'</span>, <span class="string">'rsPort'</span>: <span class="number">3306</span>, <span class="string">'rsRole'</span>: <span class="string">'master'</span>, <span class="string">'logFile'</span>: <span class="string">'m_3306_11_20200810084828_slow.log'</span>, <span class="string">'ptkillLogFile'</span>: <span class="string">'/path/SlowLog/m_3306_11_20200810084828_slow.log'</span>&#125;, &#123;<span class="string">'rsHost'</span>: <span class="string">'2.2.2.2'</span>, <span class="string">'rsPort'</span>: <span class="number">3306</span>, <span class="string">'rsRole'</span>: <span class="string">'slave'</span>, <span class="string">'logFile'</span>: <span class="string">'s_3306_22_20200810084828_slow.log'</span>, <span class="string">'ptkillLogFile'</span>: <span class="string">'/path/SlowLog/s_3306_22_20200810084828_slow.log'</span>&#125;, &#123;<span class="string">'rsHost'</span>: <span class="string">'3.3.3.3'</span>, <span class="string">'rsPort'</span>: <span class="number">3306</span>, <span class="string">'rsRole'</span>: <span class="string">'slave'</span>, <span class="string">'logFile'</span>: <span class="string">'s_3306_33_20200810084828_slow.log'</span>, <span class="string">'ptkillLogFile'</span>: <span class="string">'/path/SlowLog/s_3306_33_20200810084828_slow.log'</span>&#125;]</span><br></pre></td></tr></table></figure>
<h3 id="2、执行pt-kill并获取慢SQL数量"><a href="#2、执行pt-kill并获取慢SQL数量" class="headerlink" title="2、执行pt-kill并获取慢SQL数量"></a>2、执行pt-kill并获取慢SQL数量</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 后面的info都一直表示获取初始化信息后的里面的字典格式</span></span><br><span class="line"><span class="comment"># 例如：&#123;'rsHost': '1.1.1.1', 'rsPort': 3306, 'rsRole': 'master', 'logFile': 'm_3306_11_20200810084828_slow.log', 'ptkillLogFile': '/path/SlowLog/m_3306_11_20200810084828_slow.log'&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子函数</span></span><br><span class="line"><span class="comment">## 执行pt-kill命令，pt-kill一次只执行60s</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ExecutePtkillCmd</span><span class="params">(**info)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ptkillCmd = <span class="string">"/opt/soft/percona-toolkit-2.2.14/bin/pt-kill --no-version-check "</span> \</span><br><span class="line">                    <span class="string">"--host &#123;rsHost&#125; --port &#123;rsPort&#125; --user 'dba' --password '5d63f33c10b8f430'"</span> \</span><br><span class="line">                    <span class="string">" --busy-time 2 --match-state='Sending data|Sorting result' --victim all "</span> \</span><br><span class="line">                    <span class="string">"--interval 1 --run-time 60 --daemonize  --kill --print --log=&#123;ptkillLogFile&#125;"</span>.format(**info)</span><br><span class="line">        status, ret = executeSSH(<span class="string">'10.148.16.25'</span>, ptkillCmd)</span><br><span class="line">        <span class="keyword">if</span> status == <span class="number">0</span>:</span><br><span class="line">            msg = <span class="string">"Execute &#123;rsHost&#125;:&#123;rsPort&#125; pt-kill command success."</span>.format(**info)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span>, msg</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">"Execute &#123;rsHost&#125;:&#123;rsPort&#125; pt-kill command failed, Cmd:"</span>.format(**info), ptkillCmd</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">        msg = <span class="string">"Execute &#123;rsHost&#125;:&#123;rsPort&#125; pt-kill command error."</span>.format(**info), err</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 获取慢SQL数量，并写入info中</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetFileRegixCount</span><span class="params">(**info)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logPwd = info[<span class="string">'ptkillLogFile'</span>]</span><br><span class="line">        process = Popen([<span class="string">'grep'</span>, <span class="string">'^# [0-9]\&#123;4\&#125;-[0-9]\&#123;2\&#125;-[0-9]\&#123;2\&#125;'</span>, logPwd], stdout=PIPE)</span><br><span class="line">        info[<span class="string">'slowSQLCount'</span>] = len((process.stdout).readlines())</span><br><span class="line">        msg = <span class="string">"Get &#123;rsHost&#125;:&#123;rsPort&#125; slow log count success."</span>.format(**info)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, info</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">        msg = <span class="string">"Get &#123;rsHost&#125;:&#123;rsPort&#125; slow log count err:"</span>.format(**info), err</span><br><span class="line">        log.error(msg)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br><span class="line"><span class="comment">### 输出info格式类似为：</span></span><br><span class="line">&#123;<span class="string">'rsHost'</span>: <span class="string">'1.1.1.1'</span>, <span class="string">'rsPort'</span>: <span class="number">3306</span>, <span class="string">'rsRole'</span>: <span class="string">'master'</span>, <span class="string">'logFile'</span>: <span class="string">'m_3306_11_20200810084828_slow.log'</span>, <span class="string">'ptkillLogFile'</span>: <span class="string">'/path/SlowLog/m_3306_11_20200810084828_slow.log'</span>, <span class="string">'slowSQLCount'</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 每60s触发一次pt-kill的执行</span></span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">killSlowSql</span><span class="params">(info)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        status, msg = ExecutePtkillCmd(**info)</span><br><span class="line">        <span class="keyword">if</span> status <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">            <span class="keyword">return</span> status, msg</span><br><span class="line">        sleep(<span class="number">60</span>) </span><br><span class="line">        <span class="keyword">return</span> GetFileRegixCount(**info)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">        msg = <span class="string">"kill &#123;rsHost&#125;:&#123;rsPort&#125; &#123;ptkillLogFile&#125; err:"</span>.format(**info), err</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 多进程执行pt-kill</span></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(*HostInfoList)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pool = Pool(<span class="number">8</span>)</span><br><span class="line">        res_l = []</span><br><span class="line">        infoList = []</span><br><span class="line">        <span class="keyword">for</span> info <span class="keyword">in</span> HostInfoList:</span><br><span class="line">            base = pool.apply_async(killSlowSql, (info, ))</span><br><span class="line">            res_l.append(base)</span><br><span class="line">        pool.close()</span><br><span class="line">        pool.join()</span><br><span class="line">        <span class="keyword">for</span> res <span class="keyword">in</span> res_l:</span><br><span class="line">            ret = res.get()</span><br><span class="line">            infoList.append(ret[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, infoList</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, err</span><br></pre></td></tr></table></figure>
<h3 id="3、邮件正文html表格"><a href="#3、邮件正文html表格" class="headerlink" title="3、邮件正文html表格"></a>3、邮件正文html表格</h3><p>由于python自带html表格样式有些许丑，所以参考<a href="https://blog.csdn.net/u012111465/article/details/82713561" target="_blank" rel="noopener">这个小姐姐的表格前端页面</a>来进行了修改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">head = \</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        &lt;head&gt;</span></span><br><span class="line"><span class="string">            &lt;meta charset="utf-8"&gt;</span></span><br><span class="line"><span class="string">            &lt;STYLE TYPE="text/css" MEDIA=screen&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                table.dataframe &#123;</span></span><br><span class="line"><span class="string">                    border-collapse: collapse;</span></span><br><span class="line"><span class="string">                    border: 2px solid #a19da2;</span></span><br><span class="line"><span class="string">                    /*居中显示整个表格*/</span></span><br><span class="line"><span class="string">                    margin: auto;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                table.dataframe thead &#123;</span></span><br><span class="line"><span class="string">                    border: 2px solid #91c6e1;</span></span><br><span class="line"><span class="string">                    background: #f1f1f1;</span></span><br><span class="line"><span class="string">                    padding: 10px 10px 10px 10px;</span></span><br><span class="line"><span class="string">                    color: #333333;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                table.dataframe tbody &#123;</span></span><br><span class="line"><span class="string">                    border: 2px solid #91c6e1;</span></span><br><span class="line"><span class="string">                    padding: 10px 10px 10px 10px;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                table.dataframe tr &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                table.dataframe th &#123;</span></span><br><span class="line"><span class="string">                    vertical-align: top;</span></span><br><span class="line"><span class="string">                    font-size: 14px;</span></span><br><span class="line"><span class="string">                    padding: 10px 10px 10px 10px;</span></span><br><span class="line"><span class="string">                    color: #105de3;</span></span><br><span class="line"><span class="string">                    font-family: arial;</span></span><br><span class="line"><span class="string">                    text-align: center;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                table.dataframe td &#123;</span></span><br><span class="line"><span class="string">                    text-align: center;</span></span><br><span class="line"><span class="string">                    padding: 10px 10px 10px 10px;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                body &#123;</span></span><br><span class="line"><span class="string">                    font-family: 宋体;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                h1 &#123;</span></span><br><span class="line"><span class="string">                    color: #5db446</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                div.header h2 &#123;</span></span><br><span class="line"><span class="string">                    color: #0002e3;</span></span><br><span class="line"><span class="string">                    font-family: 黑体;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                div.content h2 &#123;</span></span><br><span class="line"><span class="string">                    text-align: center;</span></span><br><span class="line"><span class="string">                    font-size: 28px;</span></span><br><span class="line"><span class="string">                    text-shadow: 2px 2px 1px #de4040;</span></span><br><span class="line"><span class="string">                    color: #fff;</span></span><br><span class="line"><span class="string">                    font-weight: bold;</span></span><br><span class="line"><span class="string">                    background-color: #008eb7;</span></span><br><span class="line"><span class="string">                    line-height: 1.5;</span></span><br><span class="line"><span class="string">                    margin: 20px 0;</span></span><br><span class="line"><span class="string">                    box-shadow: 10px 10px 5px #888888;</span></span><br><span class="line"><span class="string">                    border-radius: 5px;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                h3 &#123;</span></span><br><span class="line"><span class="string">                    font-size: 22px;</span></span><br><span class="line"><span class="string">                    background-color: rgba(0, 2, 227, 0.71);</span></span><br><span class="line"><span class="string">                    text-shadow: 2px 2px 1px #de4040;</span></span><br><span class="line"><span class="string">                    color: rgba(239, 241, 234, 0.99);</span></span><br><span class="line"><span class="string">                    line-height: 1.5;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                h4 &#123;</span></span><br><span class="line"><span class="string">                    color: #e10092;</span></span><br><span class="line"><span class="string">                    font-family: 楷体;</span></span><br><span class="line"><span class="string">                    font-size: 20px;</span></span><br><span class="line"><span class="string">                    text-align: center;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                td img &#123;</span></span><br><span class="line"><span class="string">                    /*width: 60px;*/</span></span><br><span class="line"><span class="string">                    max-width: 300px;</span></span><br><span class="line"><span class="string">                    max-height: 300px;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &lt;/STYLE&gt;</span></span><br><span class="line"><span class="string">        &lt;/head&gt;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换为表格需要的输入</span></span><br><span class="line"><span class="comment">## 输入格式类似为result=[[1,2,3],['a','b','c']], title=['id', 'name']</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_to_html</span><span class="params">(result,title)</span>:</span></span><br><span class="line">    d = &#123;&#125;</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> title:</span><br><span class="line">        d[t] = result[index]</span><br><span class="line">        index +=<span class="number">1</span></span><br><span class="line">    df = pd.DataFrame(d)</span><br><span class="line">    <span class="comment">#如数据过长，可能在表格中无法显示，加上pd.set_option语句可以避免这一情况</span></span><br><span class="line">    pd.set_option(<span class="string">'max_colwidth'</span>,<span class="number">200</span>)</span><br><span class="line">    pd.set_option(<span class="string">'colheader_justify'</span>, <span class="string">'center'</span>)</span><br><span class="line">    df = df [title]</span><br><span class="line">    <span class="comment">#h =df.to_html(index=False)</span></span><br><span class="line">    h =df.to_html(col_space=<span class="number">30</span>,border=<span class="number">1</span>,justify=<span class="string">'center'</span>)</span><br><span class="line">    h2 = h.replace(<span class="string">'class'</span>, <span class="string">'cellspacing=\"0\" class'</span>)</span><br><span class="line">    <span class="keyword">return</span> h2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化表格</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">formatHtmlTable</span><span class="params">(result, title)</span>:</span></span><br><span class="line">    df_html = convert_to_html(result,title)</span><br><span class="line">    body = \</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &lt;div align="center" class="header"&gt;</span></span><br><span class="line"><span class="string">            &lt;!--标题部分的信息--&gt;</span></span><br><span class="line"><span class="string">            &lt;h1 align="center"&gt;慢查询SQL邮件报警&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            详情请查看附件</span></span><br><span class="line"><span class="string">&lt;!--            &lt;h2 align="center"&gt;具体SQL详情请查看附件&lt;/h2&gt; --&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &lt;div class="content"&gt;</span></span><br><span class="line"><span class="string">            &lt;!--正文内容--&gt;</span></span><br><span class="line"><span class="string">            &lt;h2&gt; &lt;/h2&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &lt;div&gt;</span></span><br><span class="line"><span class="string">                &lt;h4&gt;&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                &#123;df_html&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &lt;p style="text-align: center"&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">        """</span>.format(df_html=df_html)</span><br><span class="line">    html_msg = <span class="string">"&lt;html&gt;"</span> + head + body + <span class="string">"&lt;/html&gt;"</span></span><br><span class="line">    html_msg = html_msg.replace(<span class="string">'\n'</span>,<span class="string">''</span>).encode(<span class="string">"utf-8"</span>)</span><br><span class="line">    <span class="keyword">return</span> html_msg</span><br></pre></td></tr></table></figure>
<h3 id="4、邮件发送"><a href="#4、邮件发送" class="headerlink" title="4、邮件发送"></a>4、邮件发送</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> Header</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="comment">## 发送邮件，username和password为发送人邮箱的用户名和密码。注意密码为smtp的授权码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendMail</span><span class="params">(sender, receivers, message)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        username = <span class="string">''''''</span><span class="string">'xxxx@qq.com'</span></span><br><span class="line">        password = <span class="string">'xxxxxx</span></span><br><span class="line"><span class="string">        smtp = smtplib.SMTP(host='</span>xxxx.qq.com<span class="string">', port=25)</span></span><br><span class="line"><span class="string">        smtp.login(username, password)</span></span><br><span class="line"><span class="string">        rdict = smtp.sendmail(sender, receivers, message.as_string())</span></span><br><span class="line"><span class="string">        smtp.quit()</span></span><br><span class="line"><span class="string">        msg = "send mail success"</span></span><br><span class="line"><span class="string">        return True, msg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    except smtplib.SMTPException:</span></span><br><span class="line"><span class="string">        msg = "send mail failed"</span></span><br><span class="line"><span class="string">        return False, msg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 发送报警</span></span><br><span class="line"><span class="string">def sendMailAlert(*infoList):</span></span><br><span class="line"><span class="string">    sender ='</span>xxx@qq.com<span class="string">'        # 发送人邮箱</span></span><br><span class="line"><span class="string">    receivers = ['</span>yy@<span class="number">163.</span>com<span class="string">']  # 接收人邮箱列表，可写多个</span></span><br><span class="line"><span class="string">    message = MIMEMultipart()</span></span><br><span class="line"><span class="string">    message['</span>From<span class="string">'] = Header("lichunliang", '</span>utf<span class="number">-8</span><span class="string">')  # 发送者别名</span></span><br><span class="line"><span class="string">    message['</span>To<span class="string">'] = Header("business_rds", '</span>utf<span class="number">-8</span><span class="string">')  # 接收者别名</span></span><br><span class="line"><span class="string">    subject = '</span>慢查询邮件告警测试<span class="string">'</span></span><br><span class="line"><span class="string">    message['</span>Subject<span class="string">'] = Header(subject, '</span>utf<span class="number">-8</span><span class="string">')</span></span><br><span class="line"><span class="string">#    message.attach(MIMEText(mail_msg1, '</span>plain<span class="string">', '</span>utf<span class="number">-8</span><span class="string">'))</span></span><br><span class="line"><span class="string">    sumCount = 0</span></span><br><span class="line"><span class="string">    for info in infoList:</span></span><br><span class="line"><span class="string">        sumCount += info["slowSQLCount"]</span></span><br><span class="line"><span class="string">    if sumCount &gt; 5:</span></span><br><span class="line"><span class="string">        retList = []</span></span><br><span class="line"><span class="string">        title = ['</span>rsPort<span class="string">', '</span>rsRole<span class="string">', '</span>logFile<span class="string">', '</span>slowSQLCount<span class="string">']</span></span><br><span class="line"><span class="string">        for t in title:</span></span><br><span class="line"><span class="string">            ret = []</span></span><br><span class="line"><span class="string">            [ret.append(info[t]) for info in infoList]</span></span><br><span class="line"><span class="string">            retList.append(ret)</span></span><br><span class="line"><span class="string">        for info in infoList:</span></span><br><span class="line"><span class="string">            ## 发送附件</span></span><br><span class="line"><span class="string">            att1 = MIMEText(open(info['</span>ptkillLogFile<span class="string">'], '</span>r<span class="string">b').read(), '</span>base64<span class="string">', '</span>utf<span class="number">-8</span><span class="string">')</span></span><br><span class="line"><span class="string">            att1["Content-Type"] = '</span>application/octet-stream<span class="string">'</span></span><br><span class="line"><span class="string">            att1["Content-Disposition"] = '</span>attachment; filename=&#123;&#125;<span class="string">'.format(info['</span>ptkillLogFile<span class="string">'].split('</span>/<span class="string">')[-1])</span></span><br><span class="line"><span class="string">            message.attach(att1)</span></span><br><span class="line"><span class="string">        html_msg = formatHtmlTable(retList,title)</span></span><br><span class="line"><span class="string">        message.attach(MIMEText(html_msg, '</span>html<span class="string">', '</span>utf<span class="number">-8</span><span class="string">'))</span></span><br><span class="line"><span class="string">        return sendMail(sender, receivers, message)</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        log.info('</span>Dont need sendmail.<span class="string">')</span></span><br></pre></td></tr></table></figure>
<h2 id="五、邮件报警效果"><a href="#五、邮件报警效果" class="headerlink" title="五、邮件报警效果"></a>五、邮件报警效果</h2><img src="/2020/08/10/DB/MySQL%E6%85%A2%E6%9F%A5%E8%AF%A2SQL%E8%A7%A6%E5%8F%91%E9%98%88%E5%80%BC%E9%82%AE%E4%BB%B6%E6%8A%A5%E8%AD%A6/alert1.png" style="zoom:67%;">
        </div>

        <div class="article-nav">
            
                <div class="article-prev">
                    <a class="prev btn"
                       rel="prev"
                       href="/2020/08/14/cover/"
                    >
                        <i class="fa fa-chevron-left"></i> <span class="post-nav-title-item">cover</span><span class="post-nav-item">上一篇</span>
                    </a>
                </div>
            
            
                <div class="article-next">
                    <a class="next btn"
                       rel="next"
                       href="/2020/08/06/DB/MySQL%E4%BD%BF%E7%94%A8tokuDB%E5%BC%95%E6%93%8E%E6%97%A0%E6%B3%95%E5%A4%87%E4%BB%BD%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"
                    >
                        <span class="post-nav-title-item">MySQL使用tokuDB引擎无法备份问题排查</span><span class="post-nav-item">下一篇</span> <i class="fa fa-chevron-right"></i>
                    </a>
                </div>
            
        </div>

        <div class="comment-container">
            <div class="comments-container">
    
</div>
        </div>
    </div>
</div>

    <div class="article-toc-container fade-in-down-animation">
        <div class="article-toc">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、项目背景"><span class="nav-text">一、项目背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、开发逻辑问题及处理"><span class="nav-text">二、开发逻辑问题及处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、问题梳理"><span class="nav-text">1、问题梳理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、问题处理"><span class="nav-text">2、问题处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、逻辑流程梳理"><span class="nav-text">三、逻辑流程梳理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、主要功能代码"><span class="nav-text">四、主要功能代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、获取初始化信息"><span class="nav-text">1、获取初始化信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、执行pt-kill并获取慢SQL数量"><span class="nav-text">2、执行pt-kill并获取慢SQL数量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、邮件正文html表格"><span class="nav-text">3、邮件正文html表格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、邮件发送"><span class="nav-text">4、邮件发送</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、邮件报警效果"><span class="nav-text">五、邮件报警效果</span></a></li></ol>
    </div>
</div>
        </div>
    </div>


                

            </div>

            

        </main>

        <div class="sidebar-tools">
            <div class="tools-container">
    <ul class="tools-list">
        
            <li class="search popup-trigger">
                <i class="fa fa-search"></i>
            </li>
            
<script src="/js/local-search.js"></script>

        
        <li class="mode-toggle">
            <i class="fa fa-moon-o"></i>
        </li>
        
            <li class="rss">
                <a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a>
            </li>
        
    </ul>
</div>

        </div>

        
            <div class="scroll-to-top">
                <ul>
                    <li>
                        <!--<i class="fa fa-caret-up"></i>-->
                        <span class="scroll-percent"></span>
                    </li>
                </ul>
            </div>
        
    </div>

    <div class="page-bottom">
        <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy; 2020 <a href="/">schnappi618</a>
        </div>
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动 | 主题 <a
                    href="https://github.com/XPoet/hexo-theme-ils" target="_blank">ILS v1.1.2</a>
        </div>
        
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" style="display: none">
                        访问人数<span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" style="display: none">
                        总访问量<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
</div>

    <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-icon">
            <i class="fa fa-search"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>


<script src="/js/main.js"></script>
<script src="/js/header-shrink.js"></script>
<script src="/js/toggle-mode.js"></script>



    
<script src="/js/scroll-to-top.js"></script>





    
        
<script src="/js/code-copy.js"></script>

    

    
        
<script src="/lib/anime.min.js"></script>
<script src="/js/toc.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    




</body>
</html>