<!DOCTYPE html>
<html lang="en">
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="schnappi_xxn">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        ClickHouse存储引擎之MergeTree引擎——数据存储 - Schnappi618的博客 | schnappi618&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body>

<!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> You only care about kindness, and God has its own measure </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/logo.png" />
        </div>
        <div class="name">
            <i>Schnappi618</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、按列存储"><span class="toc-text">一、按列存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、压缩数据块"><span class="toc-text">二、压缩数据块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、简介"><span class="toc-text">1、简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、压缩规则及流程"><span class="toc-text">2、压缩规则及流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、总结"><span class="toc-text">3、总结</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> You only care about kindness, and God has its own measure </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        ClickHouse存储引擎之MergeTree引擎——数据存储
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2020-07-12 15:21:13</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#clickhouse" title="clickhouse">clickhouse</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#engine" title="engine">engine</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#MergeTree" title="MergeTree">MergeTree</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="一、按列存储"><a href="#一、按列存储" class="headerlink" title="一、按列存储"></a>一、按列存储</h2><p>​    在MergeTree中，数据按列存储，每个字段也独立单独存储，每个列字段均拥有一个对应的column.bin数据文件，这些数据文件便为数据的物理存储。数据文件以分区目录的形式被组织存放，所以每个分区目录中的bin文件只保存了当前分区片段内的该列数据。按列独立存储有利于更好的进行数据压缩(相同类型数据存放在一起)，还可以最小化需扫描数据的范围。</p>
<p>​    MergeTree会将经过压缩的数据存放到对应column.bin文件中，默认使用LZ4算法，然后将数据按照声明的ORDER BY排序。最后，数据会以压缩数据块的方式被有序的写入数据文件中的。</p>
<h2 id="二、压缩数据块"><a href="#二、压缩数据块" class="headerlink" title="二、压缩数据块"></a>二、压缩数据块</h2><h3 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h3><p>​    一个压缩数据块由头信息和压缩数据两部分组成。头信息固定使用9位字节表示，具体由1个UInt8(1字节)和2个UInt32(4字节)整型组成，分别代表了使用的压缩算法类型、压缩后的数据大小和压缩前的数据大小，具体格式如图所示：</p>
<img src="/2020/07/12/clickhouse/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/ClickHouse%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E4%B9%8BMergeTree%E5%BC%95%E6%93%8E%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/cunchu_1.svg" style="zoom:80%;">

<p>​    从上图可以看出，column.bin文件由多个压缩数据块组成，每个压缩数据块的头部信息是基于CompressionMethod_CompressedSize_UncompressedSize公式生成，可通过ClickHouse提供的clickhouse-compressor工具查询到某个.bin文件中压缩数据的统计信息。这里以官方提供的测试数据hit_v1为例，执行该命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-compressor --<span class="built_in">stat</span> &lt;  /var/lib/clickhouse/data/datasets/hits_v1/201403_1_32_2/JavaEnable.bin </span><br><span class="line"><span class="comment">## 结果如下，每一行数据表示一个压缩数据块的头信息，分表表示该压缩数据块中未压缩数据大小和压缩后数据大小(打印信息和物理存储的顺序刚好相反)</span></span><br><span class="line">65536   12000</span><br><span class="line">65536   14661</span><br><span class="line">65536   4936</span><br><span class="line">65536   7506</span><br><span class="line">65536   18660</span><br><span class="line">65536   14892</span><br><span class="line">65536   17474</span><br><span class="line">65536   13464</span><br><span class="line">65536   14999</span><br><span class="line">...</span><br><span class="line">72776   1546</span><br><span class="line">68558   12639</span><br><span class="line">72089   11184</span><br><span class="line">71612   6945</span><br><span class="line">65857   11135</span><br><span class="line">7963    1559</span><br></pre></td></tr></table></figure>

<p>​    每个压缩数据块的体积，按照其压缩前的数据字节大小，被严格控制在64KB～1MB之间，上下限大小由<code>min_compress_block_size(默认65536)</code>和<code>max_compress_block_size(默认1048576)</code>参数指定。而每一个压缩数据块最终大小，则和一个index_granularity内实际的数据大小有关。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-server_1 :) <span class="keyword">select</span> * <span class="keyword">from</span> system.settings <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'%_compress_block_size%'</span>\G</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> system.settings</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%_compress_block_size%'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Row</span> <span class="number">1</span>:</span><br><span class="line">──────</span><br><span class="line"><span class="keyword">name</span>:        min_compress_block_size</span><br><span class="line"><span class="keyword">value</span>:       <span class="number">65536</span></span><br><span class="line"><span class="keyword">changed</span>:     <span class="number">0</span></span><br><span class="line">description: The actual <span class="keyword">size</span> <span class="keyword">of</span> the <span class="keyword">block</span> <span class="keyword">to</span> <span class="keyword">compress</span>, <span class="keyword">if</span> the uncompressed <span class="keyword">data</span> <span class="keyword">less</span> <span class="keyword">than</span> max_compress_block_size <span class="keyword">is</span> <span class="keyword">no</span> <span class="keyword">less</span> <span class="keyword">than</span> this <span class="keyword">value</span> <span class="keyword">and</span> <span class="keyword">no</span> <span class="keyword">less</span> <span class="keyword">than</span> the volume <span class="keyword">of</span> <span class="keyword">data</span> <span class="keyword">for</span> one mark.</span><br><span class="line"><span class="keyword">min</span>:         ᴺᵁᴸᴸ</span><br><span class="line"><span class="keyword">max</span>:         ᴺᵁᴸᴸ</span><br><span class="line">readonly:    <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Row</span> <span class="number">2</span>:</span><br><span class="line">──────</span><br><span class="line"><span class="keyword">name</span>:        max_compress_block_size</span><br><span class="line"><span class="keyword">value</span>:       <span class="number">1048576</span></span><br><span class="line"><span class="keyword">changed</span>:     <span class="number">0</span></span><br><span class="line">description: The maximum <span class="keyword">size</span> <span class="keyword">of</span> blocks <span class="keyword">of</span> uncompressed <span class="keyword">data</span> <span class="keyword">before</span> compressing <span class="keyword">for</span> writing <span class="keyword">to</span> a table.</span><br><span class="line"><span class="keyword">min</span>:         ᴺᵁᴸᴸ</span><br><span class="line"><span class="keyword">max</span>:         ᴺᵁᴸᴸ</span><br><span class="line">readonly:    <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br></pre></td></tr></table></figure>

<h3 id="2、压缩规则及流程"><a href="#2、压缩规则及流程" class="headerlink" title="2、压缩规则及流程"></a>2、压缩规则及流程</h3><p>​    MergeTree在数据存储过程中，会遵循以下规则：</p>
<ul>
<li>单个索引粒度间隔数据size &lt; 64KB：如果单个索引粒度数据大小小于64KB，则继续获取下一个索引粒度的数据，一直到size &gt;= 64KB，生成下一个压缩数据块。</li>
<li>单个索引粒度间隔数据 64KB &lt;= size &lt;= 1MB：如果单个索引粒度数据大小大于64KB，小于1MB，则直接生成下一个压缩数据块</li>
<li>单个索引粒度间隔数据 size &gt; 1MB：如果单个索引粒度数据大小超过1MB，则先按照1MB大小截断并生成下一个压缩数据块，剩余数据按照这三个规则对应执行。这时就会出现一批数据生成多个压缩数据块的情况。</li>
</ul>
<p><img src="/2020/07/12/clickhouse/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/ClickHouse%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E4%B9%8BMergeTree%E5%BC%95%E6%93%8E%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/cunchu_2.svg"></p>
<h3 id="3、总结"><a href="#3、总结" class="headerlink" title="3、总结"></a>3、总结</h3><p>​    一个column.bin文件是由一个到多个压缩数据块组成的，每个压缩数据块大小在64KB～1MB之间。多个压缩数据块之间，按照写入顺序首尾相接，紧密排列在一起。数据被压缩后可以减少数据大小，降低存储空间并且加快数据的传输效率，但数据的压缩和解压动作，本身也会带来额外的性能损耗，所以需要控制被压缩数据的大小。另外，在具体读取某一列的压缩数据时，首先需要将压缩数据(包含了整个压缩数据块以及下个压缩数据块的头文件)加载到内存并解压，再进行后续的数据处理。通过压缩数据块，可以在不读取整个.bin文件的情况下将读取粒度降低到压缩数据块级别，进一步缩小了数据读取的范围。</p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/img/donate.jpg">
        <p> 感谢鼓励 </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        <li>
            <a target="_blank" href="https://twitter.com/li618">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-twitter"></i>
                            </span>
            </a>
        </li>
        
        
        <li>
            <a target="_blank" href="https://www.zhihu.com/people/schnappixxn">
                            <span class="fa-stack fa-lg">
                                 <i class="iconfont icon-zhihu"></i>
                            </span>
            </a>
        </li>
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/schnappi618">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://wallenotes.github.io/" target="_blank" rel="noopener">wallenotes</a></span>
        <span>/</span>
        
        <span><a href="https://csoulsi.github.io/" target="_blank" rel="noopener">csoulsi</a></span>
        <span>/</span>
        
        <span><a href="https://blog.csdn.net/lcl_xiaowugui" target="_blank" rel="noopener">my_csdn</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud" target="_blank" rel="noopener">AirCloud</a></p>
</footer><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
